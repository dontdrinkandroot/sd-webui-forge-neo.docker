{
    # Bind to all interfaces on port 80 and 443
    # Use internal self-signed certificate for SSL
    local_certs
}

:80, :443 {
    # If AUTH_TOKEN is set, require Bearer token authentication
    # Skip authentication for OPTIONS requests (CORS preflight)
    @auth {
        expression {env.AUTH_TOKEN} != ""
        not method OPTIONS
        not header_regexp Authorization "Bearer {env.AUTH_TOKEN}"
    }
    respond @auth "Unauthorized" 401

    # Proxy all other requests to Forge Neo
    reverse_proxy localhost:7860 {
        # Prefer the original values set by the Runpod proxy (if present)
        header_up Host {http.request.header.X-Forwarded-Host}
        header_up X-Forwarded-Host {http.request.header.X-Forwarded-Host}
        header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
        header_up X-Forwarded-Port {http.request.header.X-Forwarded-Port}

        # Keep client IP chain (useful for logs/security; doesn't affect the asset URL bug)
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {http.request.header.X-Forwarded-For}

        # Trusted proxies for Cloudflare and Runpod internal networking
        # This allows Caddy to correctly parse X-Forwarded-For from these sources
        trusted_proxies 0.0.0.0/0
    }

    header {
        # Allow all origins
        Access-Control-Allow-Origin *
        # Allow all methods
        Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
        # Allow all headers
        Access-Control-Allow-Headers *
        # Expose all headers
        Access-Control-Expose-Headers *
    }

    # Handle OPTIONS requests
    @options {
        method OPTIONS
    }
    respond @options 204
}
